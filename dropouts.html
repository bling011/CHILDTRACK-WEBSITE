<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dropouts - CHILDTrack</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: "Segoe UI", Arial, sans-serif; 
      background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
      color: #2c3e50; 
      transition: all 0.4s ease;
      min-height: 100vh;
    }
    body.dark { 
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0; 
    }
    
    /* Navbar Styles */
    .navbar { 
      width: 100%; 
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
      color: white; 
      padding: 15px 35px; 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      position: fixed; 
      top: 0; 
      left: 0; 
      z-index: 1000; 
      box-shadow: 0 4px 20px rgba(255, 107, 107, 0.3);
      backdrop-filter: blur(10px);
    }
    body.dark .navbar { 
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }
    .navbar .left { display: flex; align-items: center; gap: 30px; }
    .navbar .logo { 
      font-size: 26px; 
      font-weight: 800; 
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .navbar .logo i { 
      font-size: 28px;
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    .navbar a { 
      text-decoration: none; 
      color: white; 
      font-weight: 600; 
      font-size: 15px; 
      padding: 10px 18px; 
      border-radius: 10px; 
      transition: all 0.3s ease;
      display: flex; 
      align-items: center; 
      gap: 8px;
      position: relative;
      overflow: hidden;
    }
    .navbar a::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.2);
      transition: left 0.3s ease;
    }
    .navbar a:hover::before { left: 0; }
    .navbar a:hover { 
      background: rgba(255,255,255,0.15);
      transform: translateY(-2px);
    }
    .navbar a.active { 
      background: rgba(255,255,255,0.25);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .navbar .right { display: flex; align-items: center; gap: 15px; }
    
    .user-info { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      padding: 10px 18px; 
      background: rgba(255,255,255,0.15);
      border-radius: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }
    .user-info .name { font-weight: 700; font-size: 15px; }
    .user-info .section { font-size: 13px; opacity: 0.9; }
    
    .toggle-btn, .notif-btn, .logout-btn { 
      background: rgba(255,255,255,0.2);
      color: white; 
      border: none; 
      padding: 11px 20px; 
      border-radius: 10px; 
      cursor: pointer; 
      font-size: 14px; 
      transition: all 0.3s ease;
      font-weight: 600;
      border: 1px solid rgba(255,255,255,0.3);
    }
    .toggle-btn:hover, .notif-btn:hover { 
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .logout-btn { 
      background: linear-gradient(135deg, #dc3545, #c82333);
      border: none;
    }
    .logout-btn:hover { 
      background: linear-gradient(135deg, #c82333, #bd2130);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(220,53,69,0.4);
    }
    
    /* Main Container */
    .main-container { 
      display: flex; 
      margin-top: 80px; 
      min-height: calc(100vh - 80px);
      gap: 20px;
      padding: 20px;
    }
    
    /* Sidebar */
    .sidebar { 
      width: 400px;
      background: rgba(255,255,255,0.95);
      padding: 25px;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      position: sticky;
      top: 100px;
      height: calc(100vh - 120px);
      overflow-y: auto;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    .sidebar.collapsed { 
      width: 70px; 
      padding: 25px 15px;
    }
    body.dark .sidebar { 
      background: rgba(30,41,59,0.95);
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    .sidebar-header { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      margin-bottom: 25px;
    }
    .sidebar h2 { 
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 24px; 
      font-weight: 700;
      transition: opacity 0.3s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .sidebar.collapsed h2 { opacity: 0; display: none; }
    .collapse-btn { 
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      color: white; 
      border: none; 
      width: 40px; 
      height: 40px; 
      border-radius: 50%; 
      cursor: pointer; 
      font-size: 16px; 
      transition: all 0.3s ease;
      display: flex; 
      align-items: center; 
      justify-content: center;
      box-shadow: 0 4px 15px rgba(255,107,107,0.3);
    }
    .collapse-btn:hover { 
      transform: scale(1.1) rotate(90deg);
      box-shadow: 0 6px 20px rgba(255,107,107,0.4);
    }
    .calendar-wrapper { 
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-radius: 16px; 
      padding: 15px; 
      box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
      transition: opacity 0.3s;
    }
    .sidebar.collapsed .calendar-wrapper { opacity: 0; display: none; }
    body.dark .calendar-wrapper { 
      background: linear-gradient(135deg, #1e293b, #0f172a);
    }
    .calendar-wrapper iframe { 
      border: 0; 
      border-radius: 12px; 
      width: 100%; 
      height: 600px;
    }
    
    /* Content Area */
    .content { 
      flex: 1; 
      position: relative;
      z-index: 1;
    }
    .content h1 { 
      margin-bottom: 30px; 
      font-size: 36px; 
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 800;
      text-transform: uppercase; 
      letter-spacing: 2px;
      display: flex;
      align-items: center;
      gap: 15px;
      animation: slideInDown 0.6s ease;
    }
    @keyframes slideInDown {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Stats Cards */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
      animation: fadeInUp 0.6s ease 0.2s both;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .stat-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
      border: 1px solid rgba(255,107,107,0.1);
    }
    body.dark .stat-card {
      background: linear-gradient(135deg, rgba(30,41,59,0.95), rgba(30,41,59,0.85));
      border-color: rgba(255,107,107,0.2);
    }
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(255,107,107,0.2);
    }
    .stat-card .icon {
      font-size: 32px;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .stat-card .value {
      font-size: 32px;
      font-weight: 800;
      color: #ff6b6b;
      margin-bottom: 5px;
    }
    .stat-card .label {
      font-size: 14px;
      color: #64748b;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Filter Container */
    .filter-container { 
      background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
      padding: 25px 35px; 
      border-radius: 20px; 
      box-shadow: 0 10px 40px rgba(0,0,0,0.08);
      margin-bottom: 30px; 
      display: flex; 
      gap: 20px; 
      align-items: center; 
      flex-wrap: wrap;
      border: 1px solid rgba(255,107,107,0.1);
      animation: fadeInUp 0.6s ease 0.3s both;
    }
    body.dark .filter-container { 
      background: linear-gradient(135deg, rgba(30,41,59,0.95), rgba(30,41,59,0.85));
      border-color: rgba(255,107,107,0.2);
    }
    .filter-container label { 
      font-weight: 700;
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 15px;
    }
    .filter-container input { 
      padding: 12px 18px; 
      border: 2px solid #e2e8f0;
      border-radius: 12px; 
      font-size: 14px; 
      background: white; 
      color: #2c3e50;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    body.dark .filter-container input { 
      background: #0f172a;
      color: #e2e8f0; 
      border-color: #334155;
    }
    .filter-container input:focus {
      outline: none;
      border-color: #ff6b6b;
      box-shadow: 0 0 0 4px rgba(255,107,107,0.1);
    }
    .filter-btns {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .filter-btns button {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    #clearFilterBtn {
      background: linear-gradient(135deg, #64748b, #475569);
      color: white;
      box-shadow: 0 4px 15px rgba(100,116,139,0.3);
    }
    #clearFilterBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(100,116,139,0.4);
    }
    #thisMonthBtn {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      color: white;
      box-shadow: 0 4px 15px rgba(255,107,107,0.3);
    }
    #thisMonthBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255,107,107,0.4);
    }
    
    /* Table Container */
    .table-container { 
      background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
      padding: 35px; 
      border-radius: 20px; 
      box-shadow: 0 10px 40px rgba(0,0,0,0.08);
      overflow-x: auto;
      border: 1px solid rgba(255,107,107,0.1);
      animation: fadeInUp 0.6s ease 0.4s both;
    }
    body.dark .table-container { 
      background: linear-gradient(135deg, rgba(30,41,59,0.95), rgba(30,41,59,0.85));
      border-color: rgba(255,107,107,0.2);
    }
    .table-container h2 { 
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 25px; 
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .dropout-table { 
      width: 100%; 
      border-collapse: separate;
      border-spacing: 0;
      font-size: 15px;
    }
    .dropout-table th, .dropout-table td { 
      padding: 18px 24px; 
      text-align: left;
    }
    .dropout-table th { 
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      color: white; 
      font-weight: 700;
      text-transform: uppercase; 
      font-size: 13px; 
      letter-spacing: 1px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .dropout-table th:first-child {
      border-top-left-radius: 12px;
    }
    .dropout-table th:last-child {
      border-top-right-radius: 12px;
    }
    .dropout-table tbody tr { 
      transition: all 0.3s ease;
      border-bottom: 1px solid #e2e8f0;
    }
    body.dark .dropout-table tbody tr {
      border-bottom-color: #334155;
    }
    .dropout-table tbody tr:hover { 
      background: rgba(255,107,107,0.05);
      transform: scale(1.01);
      box-shadow: 0 4px 20px rgba(255,107,107,0.1);
    }
    
    .loading { 
      text-align: center; 
      padding: 40px; 
      color: #64748b;
      font-size: 16px;
    }
    .loading i { 
      font-size: 40px; 
      margin-bottom: 15px; 
      animation: spin 1s linear infinite;
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    @keyframes spin { 
      from { transform: rotate(0deg); } 
      to { transform: rotate(360deg); } 
    }
    
    .alert { 
      padding: 18px 24px; 
      border-radius: 12px; 
      margin-bottom: 25px; 
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideInRight 0.4s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(50px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .alert i {
      font-size: 20px;
    }
    .alert.success { 
      background: linear-gradient(135deg, #d4edda, #c3e6cb);
      color: #155724; 
      border-left: 5px solid #28a745;
    }
    .alert.error { 
      background: linear-gradient(135deg, #f8d7da, #f5c6cb);
      color: #721c24; 
      border-left: 5px solid #dc3545;
    }
    .alert.info { 
      background: linear-gradient(135deg, #d1ecf1, #bee5eb);
      color: #0c5460; 
      border-left: 5px solid #17a2b8;
    }

    /* Scrollbar Styles */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 10px;
    }
    body.dark ::-webkit-scrollbar-track {
      background: #1e293b;
    }
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #ee5a52, #dc3545);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .main-container { 
        flex-direction: column; 
      }
      .sidebar { 
        width: 100%; 
        height: auto; 
        position: relative; 
        top: 0; 
      }
      .navbar .left { 
        flex-wrap: wrap; 
      }
      .content { 
        padding: 25px 20px; 
      }
      .stats-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body class="light">
  <div class="navbar">
    <div class="left">
      <div class="logo"><i class="fa-solid fa-child-reaching"></i>CHILDTrack</div>
      <a href="home.html"><i class="fa-solid fa-house"></i><span>Dashboard</span></a>
      <a href="attendance.html"><i class="fa-solid fa-clipboard-check"></i><span>Attendance</span></a>
      <a href="absences.html"><i class="fa-solid fa-clipboard-list"></i><span>Absences</span></a>
      <a href="dropouts.html" class="active"><i class="fa-solid fa-user-slash"></i><span>Dropouts</span></a>
      <a href="guardians.html"><i class="fa-solid fa-ban"></i><span>Guardians</span></a>
      <a href="parentqr.html" class="active"><i class="fa-solid fa-qrcode"></i><span>Parent QR</span></a>
    </div>
    <div class="right">
      <div class="user-info" id="userInfo">
        <div>
          <div class="name" id="userName">Loading...</div>
          <div class="section" id="userSection"></div>
        </div>
      </div>
      <button class="notif-btn" onclick="location.href='notification.html'">
        <i class="fa-solid fa-bell"></i> Notifications
      </button>
      <button class="toggle-btn" id="modeToggle"><i class="fa-solid fa-moon"></i> Dark Mode</button>
      <button class="logout-btn" id="logoutBtn"><i class="fa-solid fa-sign-out-alt"></i> Logout</button>
    </div>
  </div>

  <div class="main-container">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2><i class="fa-solid fa-calendar-days"></i> Calendar</h2>
        <button class="collapse-btn" id="collapseBtn" title="Toggle Calendar"><i class="fa-solid fa-chevron-left"></i></button>
      </div>
      <div class="calendar-wrapper">
        <iframe src="https://calendar.google.com/calendar/embed?src=en.philippines%23holiday%40group.v.calendar.google.com&ctz=Asia%2FManila" frameborder="0" scrolling="no"></iframe>
      </div>
    </aside>

    <main class="content">
      <h1><i class="fa-solid fa-user-slash"></i> Student Dropouts</h1>
      
      <!-- Stats Row -->
      <div class="stats-row">
        <div class="stat-card">
          <div class="icon"><i class="fa-solid fa-users-slash"></i></div>
          <div class="value" id="totalDropouts">0</div>
          <div class="label">Total Dropouts</div>
        </div>
        <div class="stat-card">
          <div class="icon"><i class="fa-solid fa-calendar-xmark"></i></div>
          <div class="value" id="monthlyDropouts">0</div>
          <div class="label">This Month</div>
        </div>
        <div class="stat-card">
          <div class="icon"><i class="fa-solid fa-user-xmark"></i></div>
          <div class="value" id="maleDropouts">0</div>
          <div class="label">Male</div>
        </div>
        <div class="stat-card">
          <div class="icon"><i class="fa-solid fa-user-xmark"></i></div>
          <div class="value" id="femaleDropouts">0</div>
          <div class="label">Female</div>
        </div>
      </div>
      
      <div id="alertContainer"></div>
      
      <section class="filter-container">
        <label for="filterDate"><i class="fa-solid fa-filter"></i> Filter by Date:</label>
        <input type="date" id="filterDate">
        <div class="filter-btns">
          <button id="thisMonthBtn"><i class="fa-solid fa-calendar-days"></i> This Month</button>
          <button id="clearFilterBtn"><i class="fa-solid fa-times"></i> Clear Filter</button>
        </div>
      </section>

      <section class="table-container">
        <h2><i class="fa-solid fa-table"></i> Dropout Records</h2>
        <div id="loadingIndicator" class="loading" style="display:none;">
          <i class="fa-solid fa-spinner"></i>
          <p>Loading dropout records...</p>
        </div>
        <table class="dropout-table" id="dropoutTable">
          <thead>
            <tr>
              <th>Student Name</th>
              <th>LRN</th>
              <th>Gender</th>
              <th>Date Dropped</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>
    </main>
  </div>

  <script>
    // ============================
    // AUTHENTICATION CHECK
    // ============================
    let authToken = null;
    let teacherId = null;

    function checkAuthentication() {
      authToken = localStorage.getItem("authToken") || 
                  localStorage.getItem("auth_token") || 
                  localStorage.getItem("token");
      
      teacherId = localStorage.getItem("teacherId") || 
                  localStorage.getItem("teacher_id") || 
                  localStorage.getItem("id");

      console.log("ðŸ” Authentication check:", {
        hasToken: !!authToken,
        hasTeacherId: !!teacherId,
        token: authToken ? "***" + authToken.slice(-4) : "none"
      });

      if (!authToken || !teacherId) {
        console.log("âŒ No authentication found, redirecting to login...");
        alert("âš ï¸ Please login first to access the dropouts page.");
        window.location.href = "Teacherslogin.html";
        return false;
      }

      return true;
    }

    // ============================
    // USER INFO DISPLAY
    // ============================
    function displayUserInfo() {
      const teacherName = localStorage.getItem("teacherName") || 
                         localStorage.getItem("teacher_name") || 
                         localStorage.getItem("name") || 
                         "Teacher";
      
      const teacherSection = localStorage.getItem("teacherSection") || 
                            localStorage.getItem("teacher_section") || 
                            localStorage.getItem("grade") || 
                            localStorage.getItem("section") || 
                            "";

      document.getElementById("userName").textContent = teacherName;
      document.getElementById("userSection").textContent = teacherSection ? `Grade ${teacherSection}` : "";

      console.log("ðŸ‘¤ User info displayed:", { teacherName, teacherSection });
    }

    // ============================
    // LOGOUT FUNCTIONALITY
    // ============================
    document.getElementById("logoutBtn").addEventListener("click", () => {
      if (confirm("Are you sure you want to logout?")) {
        console.log("ðŸšª Logging out...");
        
        localStorage.removeItem("authToken");
        localStorage.removeItem("auth_token");
        localStorage.removeItem("token");
        localStorage.removeItem("teacherId");
        localStorage.removeItem("teacher_id");
        localStorage.removeItem("id");
        localStorage.removeItem("teacherName");
        localStorage.removeItem("teacher_name");
        localStorage.removeItem("name");
        localStorage.removeItem("teacherSection");
        localStorage.removeItem("teacher_section");
        localStorage.removeItem("grade");
        localStorage.removeItem("section");
        localStorage.removeItem("userData");

        alert("âœ… Successfully logged out!");
        window.location.href = "Teacherslogin.html";
      }
    });

    // ============================
    // API CONFIGURATION
    // ============================
    const API_BASE = 'https://childtrack-backend.onrender.com/api';
    const API_PUBLIC_ATTENDANCE = `${API_BASE}/attendance/public`;

    let allDropoutData = [];

    function getAuthHeaders() {
      const headers = {
        'Content-Type': 'application/json',
      };
      if (authToken) {
        headers['Authorization'] = `Token ${authToken}`;
      }
      return headers;
    }

    function showAlert(message, type = 'success') {
      const alertContainer = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert ${type}`;
      alert.innerHTML = `<i class="fa-solid fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
      alertContainer.appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, 5000);
    }

    function formatDate(dateString) {
      const date = new Date(dateString + 'T00:00:00');
      return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function formatTime(timeString) {
      if (!timeString) return 'N/A';
      const [hours, minutes] = timeString.split(':');
      const hour = parseInt(hours);
      const ampm = hour >= 12 ? 'PM' : 'AM';
      const displayHour = hour % 12 || 12;
      return `${displayHour}:${minutes} ${ampm}`;
    }

    function getCurrentMonth() {
      const now = new Date();
      return now.getMonth();
    }

    function getCurrentYear() {
      const now = new Date();
      return now.getFullYear();
    }

    // ============================
    // UPDATE STATISTICS
    // ============================
    function updateStats(data, filterDate) {
      const currentMonth = getCurrentMonth();
      const currentYear = getCurrentYear();
      
      let displayData = data;
      
      // If there's a filter date, use only that data for stats
      if (filterDate) {
        displayData = data.filter(record => record.date === filterDate);
      }
      
      const totalDropouts = displayData.length;
      
      const monthlyDropouts = data.filter(record => {
        const recordDate = new Date(record.date + 'T00:00:00');
        return recordDate.getMonth() === currentMonth && recordDate.getFullYear() === currentYear;
      }).length;
      
      const maleDropouts = displayData.filter(r => 
        (r.gender || '').toLowerCase() === 'male'
      ).length;
      
      const femaleDropouts = displayData.filter(r => 
        (r.gender || '').toLowerCase() === 'female'
      ).length;
      
      document.getElementById('totalDropouts').textContent = totalDropouts;
      document.getElementById('monthlyDropouts').textContent = monthlyDropouts;
      document.getElementById('maleDropouts').textContent = maleDropouts;
      document.getElementById('femaleDropouts').textContent = femaleDropouts;
    }

    // ============================
    // LOAD DROPOUT DATA
    // ============================
    async function loadData(filterDate = null) {
      const tbody = document.querySelector("#dropoutTable tbody");
      const loadingIndicator = document.getElementById('loadingIndicator');
      
      try {
        loadingIndicator.style.display = 'block';
        tbody.innerHTML = "";
        
        let response = await fetch(API_PUBLIC_ATTENDANCE, {
          headers: getAuthHeaders()
        });
        
        if (!response.ok && response.status === 404) {
          response = await fetch(`${API_PUBLIC_ATTENDANCE}/`, {
            headers: getAuthHeaders()
          });
        }
        
        if (!response.ok) {
          const clonedResponse = response.clone();
          let errorText;
          try {
            const errorJson = await response.json();
            errorText = JSON.stringify(errorJson, null, 2);
            console.error('Load Error Response (JSON):', errorJson);
          } catch {
            try {
              errorText = await clonedResponse.text();
              console.error('Load Error Response (Text):', errorText);
            } catch {
              errorText = 'Unable to read error response';
            }
          }
          throw new Error(`HTTP error! status: ${response.status}\nDetails: ${errorText}`);
        }
        
        const data = await response.json();
        
        // Filter only records with status "Dropped Out"
        const dropoutRecords = data.filter(record => {
          const status = (record.status || '').toLowerCase();
          return status === 'dropped out' || status === 'droppedout' || status === 'dropout';
        });
        
        allDropoutData = dropoutRecords;
        
        if (dropoutRecords.length > 0) {
          console.log('âœ… Found dropout records:', dropoutRecords.length);
          console.log('Sample dropout record:', dropoutRecords[0]);
        }
        
        loadingIndicator.style.display = 'none';
        
        let displayData = dropoutRecords;
        if (filterDate) {
          displayData = dropoutRecords.filter(record => record.date === filterDate);
        }
        
        // Update statistics
        updateStats(displayData, filterDate);
        
        if (displayData.length === 0) {
          const message = filterDate ? 
            `No dropout records found for ${formatDate(filterDate)}.` : 
            'No dropout records found. Students marked as "Dropped Out" in attendance will appear here.';
          tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 40px; opacity: 0.7; font-size: 16px;"><i class="fa-solid fa-user-slash" style="font-size: 48px; margin-bottom: 15px; display: block; opacity: 0.3;"></i>${message}</td></tr>`;
          return;
        }
        
        // Sort by date (most recent first)
        displayData.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        displayData.forEach((row) => {
          const tr = document.createElement("tr");
          
          const studentName = row.student_name || row.name || 'Unknown Student';
          const studentLrn = row.student_lrn || row.lrn || 'N/A';
          const gender = row.gender || 'N/A';
          const date = row.date || '';
          const time = row.time || '';
          
          tr.innerHTML = `
            <td>
              <strong style="font-size: 15px;">${studentName}</strong>
            </td>
            <td style="font-weight: 600; color: #64748b;">
              ${studentLrn !== 'N/A' ? `<i class="fa-solid fa-id-card"></i> ${studentLrn}` : '<span style="opacity: 0.5;">No LRN</span>'}
            </td>
            <td style="font-weight: 600;">
              ${gender !== 'N/A' ? `<i class="fa-solid fa-${gender.toLowerCase() === 'male' ? 'mars' : 'venus'}"></i> ${gender}` : '<span style="opacity: 0.5;">N/A</span>'}
            </td>
            <td style="font-weight: 600; color: #ff6b6b;">
              <i class="fa-solid fa-calendar-xmark"></i> ${formatDate(date)}
            </td>
            <td style="font-weight: 600; color: #64748b;">
              ${time ? `<i class="fa-solid fa-clock"></i> ${formatTime(time)}` : '<span style="opacity: 0.5;">No time</span>'}
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (error) {
        loadingIndicator.style.display = 'none';
        console.error('Error loading dropout records:', error);
        showAlert('Error loading dropout records: ' + error.message, 'error');
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 40px; color: #dc3545;"><i class="fa-solid fa-triangle-exclamation" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>Failed to load records. Please try again.</td></tr>`;
      }
    }

    // ============================
    // FILTER BY DATE
    // ============================
    document.getElementById('filterDate').addEventListener('change', (e) => {
      loadData(e.target.value || null);
    });

    // This month button
    document.getElementById('thisMonthBtn').addEventListener('click', () => {
      const currentMonth = getCurrentMonth();
      const currentYear = getCurrentYear();
      
      const tbody = document.querySelector("#dropoutTable tbody");
      tbody.innerHTML = "";
      
      const monthlyData = allDropoutData.filter(record => {
        const recordDate = new Date(record.date + 'T00:00:00');
        return recordDate.getMonth() === currentMonth && recordDate.getFullYear() === currentYear;
      });
      
      updateStats(monthlyData, null);
      
      if (monthlyData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 40px; opacity: 0.7; font-size: 16px;"><i class="fa-solid fa-user-slash" style="font-size: 48px; margin-bottom: 15px; display: block; opacity: 0.3;"></i>No dropout records found for this month.</td></tr>`;
        return;
      }
      
      monthlyData.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      monthlyData.forEach((row) => {
        const tr = document.createElement("tr");
        
        const studentName = row.student_name || row.name || 'Unknown Student';
        const studentLrn = row.student_lrn || row.lrn || 'N/A';
        const gender = row.gender || 'N/A';
        const date = row.date || '';
        const time = row.time || '';
        
        tr.innerHTML = `
          <td>
            <strong style="font-size: 15px;">${studentName}</strong>
          </td>
          <td style="font-weight: 600; color: #64748b;">
            ${studentLrn !== 'N/A' ? `<i class="fa-solid fa-id-card"></i> ${studentLrn}` : '<span style="opacity: 0.5;">No LRN</span>'}
          </td>
          <td style="font-weight: 600;">
            ${gender !== 'N/A' ? `<i class="fa-solid fa-${gender.toLowerCase() === 'male' ? 'mars' : 'venus'}"></i> ${gender}` : '<span style="opacity: 0.5;">N/A</span>'}
          </td>
          <td style="font-weight: 600; color: #ff6b6b;">
            <i class="fa-solid fa-calendar-xmark"></i> ${formatDate(date)}
          </td>
          <td style="font-weight: 600; color: #64748b;">
            ${time ? `<i class="fa-solid fa-clock"></i> ${formatTime(time)}` : '<span style="opacity: 0.5;">No time</span>'}
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      document.getElementById('filterDate').value = '';
      showAlert(`ðŸ“Š Showing ${monthlyData.length} dropout(s) for this month`, 'info');
    });

    // Clear filter
    document.getElementById('clearFilterBtn').addEventListener('click', () => {
      document.getElementById('filterDate').value = '';
      loadData(null);
      showAlert('ðŸ”„ Filter cleared - showing all dropout records', 'info');
    });

    // ============================
    // DARK MODE TOGGLE
    // ============================
    const toggleBtn = document.getElementById("modeToggle");
    const body = document.body;
    
    function updateToggleText() {
      toggleBtn.innerHTML = body.classList.contains("dark")
        ? '<i class="fa-solid fa-sun"></i> Light Mode'
        : '<i class="fa-solid fa-moon"></i> Dark Mode';
    }
    
    toggleBtn.addEventListener("click", () => {
      body.classList.toggle("dark");
      body.classList.toggle("light");
      updateToggleText();
      
      const mode = body.classList.contains("dark") ? "dark" : "light";
      localStorage.setItem("theme", mode);
    });

    const savedTheme = localStorage.getItem("theme") || "light";
    body.classList.remove("light", "dark");
    body.classList.add(savedTheme);
    updateToggleText();

    // ============================
    // SIDEBAR COLLAPSE
    // ============================
    const sidebar = document.getElementById("sidebar");
    const collapseBtn = document.getElementById("collapseBtn");
    const collapseBtnIcon = collapseBtn.querySelector("i");
    
    collapseBtn.addEventListener("click", () => {
      sidebar.classList.toggle("collapsed");
      
      if (sidebar.classList.contains("collapsed")) {
        collapseBtnIcon.classList.remove("fa-chevron-left");
        collapseBtnIcon.classList.add("fa-chevron-right");
        localStorage.setItem("sidebarCollapsed", "true");
      } else {
        collapseBtnIcon.classList.remove("fa-chevron-right");
        collapseBtnIcon.classList.add("fa-chevron-left");
        localStorage.setItem("sidebarCollapsed", "false");
      }
    });

    const sidebarCollapsed = localStorage.getItem("sidebarCollapsed");
    if (sidebarCollapsed === "true") {
      sidebar.classList.add("collapsed");
      collapseBtnIcon.classList.remove("fa-chevron-left");
      collapseBtnIcon.classList.add("fa-chevron-right");
    }

    // ============================
    // INITIALIZATION
    // ============================
    window.onload = function() {
      if (checkAuthentication()) {
        displayUserInfo();
        loadData(null);
        console.log("âœ… Dropouts page loaded successfully");
        showAlert('ðŸ“Š Showing students marked as "Dropped Out" from attendance records', 'info');
      }
    };
  </script>
</body>
</html>



