<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Teacher Login - CHILDTrack</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #D4A574;
      color: #222;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      transition: background 0.4s, color 0.4s;
      padding: 20px;
    }

    body.dark {
      background: #1e1e2f;
      color: #e0e0e0;
    }

    .login-box {
      background: #fff;
      padding: 40px 50px;
      border-radius: 16px;
      width: 100%;
      max-width: 450px;
      box-shadow: 0 6px 25px rgba(0,0,0,0.2);
      transition: background 0.4s, color 0.4s;
      animation: fadeIn 0.8s ease;
    }

    body.dark .login-box {
      background: #2b2b3d;
      color: #f1f1f1;
      box-shadow: 0 6px 25px rgba(0,0,0,0.4);
    }

    .login-box h2 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 28px;
      color: #2d5016;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .login-box label {
      display: block;
      margin: 12px 0 6px;
      font-weight: 600;
      font-size: 15px;
    }

    .login-box input {
      width: 100%;
      padding: 12px;
      margin-bottom: 18px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 15px;
      transition: all 0.3s;
    }

    .login-box input:focus {
      border: 1px solid #38c586;
      outline: none;
      box-shadow: 0 0 8px rgba(56,197,134,0.4);
    }

    body.dark .login-box input {
      background: #333;
      border: 1px solid #555;
      color: #eee;
    }

    .login-box button {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #2d5016, #2d5016);
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      transition: all 0.3s;
    }

    .login-box button:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }

    .login-box button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .login-box p {
      text-align: center;
      margin-top: 20px;
      font-size: 14px;
    }

    .login-box a {
      color: #2d5016;
      text-decoration: none;
      font-weight: bold;
      transition: color 0.3s;
    }

    .login-box a:hover {
      color: #2fa46e;
    }

    .topbar {
      position: absolute;
      top: 20px;
      right: 30px;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      height: 50px;
      width: auto;
    }

    .toggle-btn {
      background: #2d5016;
      color: white;
      border: none;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .toggle-btn:hover {
      background: #2d5016;
      transform: scale(1.1);
    }

    body.dark .toggle-btn {
      background: #2d5016;
    }

    .alert {
      padding: 12px 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      display: none;
    }

    .alert.show {
      display: block;
      animation: slideDown 0.3s ease;
    }

    .alert.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    body.dark .alert.success {
      background: #155724;
      color: #d4edda;
    }

    body.dark .alert.error {
      background: #721c24;
      color: #f8d7da;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <img src="logo.png" alt="Logo" class="logo">
    <button class="toggle-btn" id="darkModeBtn">üåô</button>
  </div>

  <div class="login-box">
    <h2>Teacher Login</h2>
    
    <div id="alertBox" class="alert"></div>

    <form id="teacherLoginForm">
      <label for="name">Full Name *</label>
      <input type="text" id="name" required>

      <label for="password">Password *</label>
      <input type="password" id="password" required>

      <label for="grade">Grade Handling (Optional)</label>
      <input type="text" id="grade" placeholder="e.g. Grade 6">

      <button type="submit" id="submitBtn">Login</button>
    </form>
    
    <p>Don't have an account? <a href="Teachersregistration.html">Register here</a></p>
  </div>

  <script>
    const API_BASE = "https://childtrack-backend.onrender.com/api";

    // Dark mode toggle
    const darkModeBtn = document.getElementById('darkModeBtn');
    darkModeBtn.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      darkModeBtn.textContent = document.body.classList.contains('dark') ? "‚òÄÔ∏è" : "üåô";
    });

    // Show alert message
    function showAlert(message, type = 'success') {
      const alertBox = document.getElementById('alertBox');
      alertBox.textContent = message;
      alertBox.className = `alert ${type} show`;
      
      setTimeout(() => {
        alertBox.classList.remove('show');
      }, 5000);
    }

    // Login teacher via API
    async function loginTeacher(credentials) {
      try {
        console.log("üîê Attempting login with:", { ...credentials, password: "***" });

        // Based on your URLs: path('login/', LoginView.as_view(), name='login')
        const endpoint = `${API_BASE}/login/`;
        
        // Generate username from name for alternative attempts
        const username = credentials.name.toLowerCase().replace(/\s+/g, '_');
        
        // Try multiple payload formats
        const payloads = [
          // Format 1: Using 'name' field (might be your custom implementation)
          {
            name: credentials.name,
            password: credentials.password,
            ...(credentials.grade && { grade: credentials.grade })
          },
          // Format 2: Standard Django 'username' field (generated from name)
          {
            username: username,
            password: credentials.password,
            ...(credentials.grade && { grade: credentials.grade })
          },
          // Format 3: Using original name as username
          {
            username: credentials.name,
            password: credentials.password,
            ...(credentials.grade && { grade: credentials.grade })
          }
        ];

        let lastError = null;

        // Try each payload format
        for (let i = 0; i < payloads.length; i++) {
          try {
            console.log(`üîÑ Trying ${endpoint} with payload format ${i + 1}/${payloads.length}`);
            console.log(`üì§ Payload:`, { ...payloads[i], password: '***' });
            
            const response = await fetch(endpoint, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payloads[i]),
            });

            console.log(`üì° Response status: ${response.status}`);

            // Get response text first
            const text = await response.text();
            
            // Skip HTML error pages
            if (text.includes('<!doctype html>') || text.includes('<html')) {
              console.error(`‚ö†Ô∏è Server returned HTML error page`);
              lastError = 'Server configuration error';
              
              // Don't continue trying if we get a 500 error
              if (response.status === 500) {
                break;
              }
              continue;
            }

            console.log("üìÑ Response preview:", text.substring(0, 300));

            // Try to parse as JSON
            let data;
            try {
              data = JSON.parse(text);
            } catch (e) {
              console.log(`‚ö†Ô∏è Could not parse JSON, trying next format...`);
              lastError = 'Invalid server response';
              continue;
            }

            if (!response.ok) {
              // Handle specific error messages
              if (data.detail || data.error || data.message || data.non_field_errors) {
                const errorMsg = data.detail || data.error || data.message || 
                               (data.non_field_errors ? data.non_field_errors.join(', ') : '');
                console.log(`‚ö†Ô∏è Error: ${errorMsg}`);
                
                // If it's an authentication error, try next format
                if (response.status === 400 || response.status === 401) {
                  lastError = errorMsg;
                  continue;
                }
                
                // For other errors, throw immediately
                throw new Error(errorMsg);
              }
              
              // Handle field-level errors
              const fieldErrors = [];
              for (const [field, messages] of Object.entries(data)) {
                if (Array.isArray(messages)) {
                  fieldErrors.push(`${field}: ${messages.join(', ')}`);
                }
              }
              
              if (fieldErrors.length > 0) {
                lastError = fieldErrors.join('\n');
                continue;
              }
              
              lastError = `Login failed with status ${response.status}`;
              continue;
            }

            // Success!
            console.log("‚úÖ Login successful with payload format", i + 1);
            console.log("‚úÖ Response data:", data);
            return { success: true, data };
            
          } catch (error) {
            console.log(`‚ùå Error with format ${i + 1}:`, error.message);
            lastError = error.message;
            
            // If it's a clear validation error, don't try other formats
            if (!error.message.includes('credentials') && 
                !error.message.includes('username') && 
                !error.message.includes('field')) {
              break;
            }
          }
        }

        // If we get here, all attempts failed
        throw new Error(lastError || 'Login failed. Please check your credentials.');

      } catch (error) {
        console.error("‚ùå Login error:", error);
        return { success: false, error: error.message };
      }
    }

    // Form submission
    document.getElementById('teacherLoginForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Logging in...';

      const credentials = {
        name: document.getElementById('name').value.trim(),
        password: document.getElementById('password').value,
        grade: document.getElementById('grade').value.trim()
      };

      // Login via API
      const result = await loginTeacher(credentials);

      if (result.success) {
        // CRITICAL: Save authentication data with consistent key names
        // Use both formats for backward compatibility
        const token = result.data.token || result.data.auth_token || result.data.key;
        const teacherId = result.data.teacher_id || result.data.id || result.data.user_id;
        const teacherName = result.data.name || credentials.name;
        const teacherSection = result.data.section || result.data.grade || credentials.grade;

        // Save with both key formats for compatibility
        localStorage.setItem("authToken", token);
        localStorage.setItem("auth_token", token); // For attendance page
        localStorage.setItem("teacherId", teacherId);
        localStorage.setItem("teacher_id", teacherId); // For attendance page
        localStorage.setItem("teacherName", teacherName);
        localStorage.setItem("teacher_name", teacherName);
        localStorage.setItem("teacherSection", teacherSection);
        localStorage.setItem("teacher_section", teacherSection);

        // Save complete user data as JSON for future use
        localStorage.setItem("userData", JSON.stringify({
          token: token,
          id: teacherId,
          name: teacherName,
          section: teacherSection,
          loginTime: new Date().toISOString()
        }));

        console.log("üíæ Saved to localStorage:", {
          token: token ? "***" + token.slice(-4) : "none",
          teacherId,
          teacherName,
          teacherSection
        });

        showAlert("‚úÖ Login successful! Redirecting...", "success");
        
        setTimeout(() => {
          window.location.href = "home.html";
        }, 1000);
      } else {
        showAlert("‚ùå " + result.error, "error");
        submitBtn.disabled = false;
        submitBtn.textContent = 'Login';
      }
    });
  </script>
</body>
</html>